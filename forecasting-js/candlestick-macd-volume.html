<!DOCTYPE html>
<html style="height: 100%">
    <head>
       <meta charset="utf-8">
    </head>
    <body style="height: 100%; margin: 0">

        <button id="calldbtn">Call DB</button>
        <div id="container" style="height: 100%"></div>
        <script src="js/jquery-3.3.1.min.js"></script>
        <script src="js/materialize.min.js"></script>
        <script src="js/echarts.min.js"></script>
        <script src="js/echarts-gl.min.js"></script>
        <script src="js/papaparse.min.js"></script>
<script type="text/javascript">

//数据模型 time0 open1 close2 min3 max4 vol5 tag6 macd7 dif8 dea9
//['2015-10-19',18.56,18.25,18.19,18.56,55.00,0,-0.00,0.08,0.09]
var data = splitData([['2015-10-16',18.4,18.58,18.33,18.79,67.00,1,0.04,0.11,0.09],
    ['2015-10-19',18.56,18.25,18.19,18.56,55.00,0,-0.00,0.08,0.09],
    ['2015-10-20',18.3,18.22,18.05,18.41,37.00,0,0.01,0.09,0.09],
    ['2015-10-21',18.18,18.69,18.02,18.98,89.00,0,0.03,0.10,0.08],
    ['2015-10-22',18.42,18.29,18.22,18.48,43.00,0,-0.06,0.05,0.08],
    ['2015-10-23',18.26,18.19,18.08,18.36,46.00,0,-0.10,0.03,0.09],
    ['2015-10-26',18.33,18.07,17.98,18.35,65.00,0,-0.15,0.03,0.10],
    ['2015-10-27',18.08,18.04,17.88,18.13,37.00,0,-0.19,0.03,0.12],
    ['2015-10-28',17.96,17.86,17.82,17.99,35.00,0,-0.24,0.03,0.15],
    ['2015-10-29',17.85,17.81,17.8,17.93,27.00,0,-0.24,0.06,0.18],
    ['2015-10-30',17.79,17.93,17.78,18.08,43.00,0,-0.22,0.11,0.22],
    ['2015-11-02',17.78,17.83,17.78,18.04,27.00,0,-0.20,0.15,0.25],
    ['2015-11-03',17.84,17.9,17.84,18.06,34.00,0,-0.12,0.22,0.28],
    ['2015-11-04',17.97,18.36,17.85,18.39,62.00,0,-0.00,0.30,0.30],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],
    ['2015-11-05',18.3,18.57,18.18,19.08,177.00,0,0.07,0.33,0.30],['2015-11-06',18.53,18.68,18.3,18.71,95.00,0,0.12,0.35,0.29],

    ['2015-11-09',18.75,19.08,18.75,19.98,202.00,1,0.16,0.35,0.27]]);

function splitData(rawData) {
  var datas = [];
  var times = [];
  var vols = [];
  var macds = []; var difs = []; var deas = [];
  for (var i = 0; i < rawData.length; i++) {
	  datas.push(rawData[i]);
	  times.push(rawData[i].splice(0, 1)[0]);
	  vols.push(rawData[i][4]);
	  macds.push(rawData[i][6]);
	  difs.push(rawData[i][7]);
	  deas.push(rawData[i][8]);
  }
  return {
      datas: datas,
      times: times,
      vols: vols,
      macds: macds,
      difs: difs,
      deas: deas
  };
}

function fenduans(){
  var markLineData = [];
  var idx = 0; var tag = 0; var vols = 0;
  for (var i = 0; i < data.times.length; i++) {
	  //初始化数据
      if(data.datas[i][5] != 0 && tag == 0){
          idx = i; vols = data.datas[i][4]; tag = 1;
      }
      if(tag == 1){ vols += data.datas[i][4]; }
      if(data.datas[i][5] != 0 && tag == 1){
          markLineData.push([{
              xAxis: idx,
              yAxis: data.datas[idx][1]>data.datas[idx][0]?(data.datas[idx][3]).toFixed(2):(data.datas[idx][2]).toFixed(2),
              value: vols
          }, {
              xAxis: i,
              yAxis: data.datas[i][1]>data.datas[i][0]?(data.datas[i][3]).toFixed(2):(data.datas[i][2]).toFixed(2)
          }]);
          idx = i; vols = data.datas[i][4]; tag = 2;
      }

      //更替数据
      if(tag == 2){ vols += data.datas[i][4]; }
      if(data.datas[i][5] != 0 && tag == 2){
          markLineData.push([{
              xAxis: idx,
              yAxis: data.datas[idx][1]>data.datas[idx][0]?(data.datas[idx][3]).toFixed(2):(data.datas[idx][2]).toFixed(2),
              value: (vols/(i-idx+1)).toFixed(2)+' M'
          }, {
              xAxis: i,
              yAxis: data.datas[i][1]>data.datas[i][0]?(data.datas[i][3]).toFixed(2):(data.datas[i][2]).toFixed(2)
          }]);
          idx = i; vols = data.datas[i][4];
      }
  }
  return markLineData;
}

function calculateMA(dayCount) {
  var result = [];
  for (var i = 0, len = data.times.length; i < len; i++) {
      if (i < dayCount) {
          result.push('-');
          continue;
      }
      var sum = 0;
      for (var j = 0; j < dayCount; j++) {
          sum += data.datas[i - j][1];
      }
      result.push((sum / dayCount).toFixed(2));
  }
  return result;
}



function getOption(data){
    var app = {};
    // for bitcoin
    // var upColor = '#00da3c';
    // var upBorderColor = '#008F28';
    // var downColor = '#ec0000';
    // var downBorderColor = '#8A0000';

    // for stock
    var upColor = '#ec0000';
    var upBorderColor = '#8A0000';
    var downColor = '#00da3c';
    var downBorderColor = '#008F28';

    var option = {
      title: {
          text: 'K线周期图表(matols.com)',
          left: 0
      },
      tooltip: {
          trigger: 'axis',
          axisPointer: {
              type: 'line'
          }
      },
      legend: {
          data: ['KLine', 'MA5']
      },
      grid: [           {
          left: '3%',
          right: '1%',
          height: '60%'
      },{
          left: '3%',
          right: '1%',
          top: '71%',
          height: '10%'
      },{
          left: '3%',
          right: '1%',
          top: '82%',
          height: '14%'
      }],
      xAxis: [{
          type: 'category',
          data: data.times,
          scale: true,
          boundaryGap: false,
          axisLine: { onZero: false },
          splitLine: { show: false },
          splitNumber: 20,
          min: 'dataMin',
          max: 'dataMax'
      },{
          type: 'category',
          gridIndex: 1,
          data: data.times,
          axisLabel: {show: false}
      },{
          type: 'category',
          gridIndex: 2,
          data: data.times,
          axisLabel: {show: false}
      }],
      yAxis: [{
          scale: true,
          splitArea: {
              show: false
          }
      },{
          gridIndex: 1,
          splitNumber: 3,
          axisLine: {onZero: false},
          axisTick: {show: false},
          splitLine: {show: false},
          axisLabel: {show: true}
      },{
          gridIndex: 2,
          splitNumber: 4,
          axisLine: {onZero: false},
          axisTick: {show: false},
          splitLine: {show: false},
          axisLabel: {show: true}
      }],
      dataZoom: [{
              type: 'inside',
              xAxisIndex: [0, 0],
              start: 20,
              end: 100
        },{
              show: true,
              xAxisIndex: [0, 1],
              type: 'slider',
              top: '97%',
              start: 20,
              end: 100
        },{
          show: false,
          xAxisIndex: [0, 2],
          type: 'slider',
          start: 20,
          end: 100
      }],
      series: [{
              name: 'K线周期图表(matols.com)',
              type: 'candlestick',
              data: data.datas,
              itemStyle: {
                  normal: {
                      color: '#ef232a',
                      color0: '#14b143',
                      borderColor: '#ef232a',
                      borderColor0: '#14b143'
                  }
              },
              markArea: {
                  silent: true,
                  itemStyle: {
                      normal: {
                          color: 'Honeydew'
                      }
                  },
                  data: fenduans()
              },
              markPoint: {
                  data: [
                      {type: 'max', name: '最大值'},
                      {type: 'min', name: '最小值'}
                  ]
              },
              markLine: {
                  label: {
                      normal: {
                          position: 'middle',
                          textStyle:{color:'Blue',fontSize: 15}
                      }
                  },
                  data: fenduans(),
                  symbol: ['circle', 'none']

              }
          }, {
              name: 'MA5',
              type: 'line',
              data: calculateMA(5),
              smooth: true,
              lineStyle: {
                  normal: {
                      opacity: 0.5
                  }
              }
          },{
              name: 'Volumn',
              type: 'bar',
              xAxisIndex: 1,
              yAxisIndex: 1,
              data: data.vols,
              itemStyle: {
                  normal: {
                      color: function(params) {
                          var colorList;
                          if (data.datas[params.dataIndex][1]>data.datas[params.dataIndex][0]) {
                              colorList = '#ef232a';
                          } else {
                              colorList = '#14b143';
                          }
                          return colorList;
                      },
                  }
              }
          },{
              name: 'MACD',
              type: 'bar',
              xAxisIndex: 2,
              yAxisIndex: 2,
              data: data.macds,
              itemStyle: {
                  normal: {
                      color: function(params) {
                          var colorList;
                          if (params.data >= 0) {
                              colorList = '#ef232a';
                          } else {
                              colorList = '#14b143';
                          }
                          return colorList;
                      },
                  }
              }
          },{
              name: 'DIF',
              type: 'line',
              xAxisIndex: 2,
              yAxisIndex: 2,
              data: data.difs
          },{
              name: 'DEA',
              type: 'line',
              xAxisIndex: 2,
              yAxisIndex: 2,
              data: data.deas
          }
      ]
    };
    return option
}

function plot_chart_sh(data){
    var dom = document.getElementById("container");
    var myChart = echarts.init(dom);
    option = null;

    // [datatime, open, close，low，high]
    // var data = splitData(data);
    option = getOption(data);

    if (option && typeof option === "object") {
        myChart.setOption(option, true);
    }
}

// when click button
$('#calldbtn').click(function(){

    plot_chart_sh(data)

    url = 'http://127.0.0.1:8007/charts/sh_volume_macd';

    // $.ajax({
    //     type: "POST",
    //     dataType: "json",
    //     async: true,
    //     url: url,
    //     success: function(results){
    //         // alert(results.data);
    //         plot_chart_sh(results.data);
    //     },
    //     error: function(data) {
    //         alert(JSON.stringify(data));
    //     }
    //
    // });

})

</script>

   </body>
</html>
